<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Room</title>
    <link rel="icon" href="/images/favicon.png" type="image/png">
    <style>
        body {
            background-color: #2B70E4;
            font-family: 'Chau', sans-serif;
            color: white;
            text-align: center;
        }
        .logo-container {
            display: flex;
            justify-content: center;
            padding-top: 40px; 
            padding-bottom: 40px; 
        }
        .room-info {
            font-size: 20px;
        }
        .room-code {
            display: flex;
            justify-content: center;
            font-family: 'Chau', sans-serif;
            font-size: 90px;
            font-weight: bold;
        }
        .user-list {
            list-style-type: none;
            padding: 0;
        }
        .user-list li {
            font-size: 25px;
            margin: 10px 0;
        }
        .hidden {
            display: none;
        }
        @font-face {
            font-family: 'Chau';
            src: url('/fonts/ChauPhilomeneOne-Regular.ttf') format('truetype');
        }

        #chat-sidebar {
            position: fixed;
            right: 0;
            bottom: 0;
            width: 300px;
            height: 97%;
            background-color: white;
            border-radius: 15px;
            color: black;
            box-shadow: -2px 0 5px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            padding: 10px;
            display: none;
        }

        #chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #chat-messages {
            flex: 1;
            overflow-y: auto;
            align-items: start;
            margin-bottom: 10px;
        }

        #chat-input {
            width: calc(100% - 10px);
            background-color: black;
            color: white;
            border-radius: 15px;

            padding: 10px;
        }

        #send-chat {
            width: 50px;
            padding: 10px;
        }


    </style>
</head>
<body>
    <div class="logo-container">
        <img src="/images/MemeWorthyLogo.png" alt="Meme Worthy Logo" style="max-width: 33%; min-width: 300px; height: auto;">
    </div>
    <h1 class="room-info">Welcome to the Game Room</h1>
    <p id="current-user" class="room-info"></p>
    <p class="room-info">Tell your friends to join using this code:</p>
    <div id="room-code" class="room-code"></div>

    <p class="room-info">Users in this room:</p>
    <ul id="users-list" class="user-list"></ul>

    <button id="start-game">Start Game</button>
    <div id="game-prompt" class="hidden"></div>
    <div id="gif-container" class="hidden">
        <input id="gif-search" type="text" placeholder="Search for a GIF">
        <button id="search-gif">Search</button>
        <div id="gif-results"></div>
    </div>
    <div id="voting-container" class="hidden">
        <h2>Vote for GIFs</h2>
        <div id="gif-votes"></div>
        <button id="submit-votes">Submit Votes</button>
    </div>

    <div id="chat-sidebar">
        <div id="chat-header">
            <h2>Chat</h2>
            <button id="close-chat">Close</button>
        </div>
        <div id="chat-messages"></div>
        <input id="chat-input" type="text" placeholder="Type a message...">
        <button id="send-chat">Send</button>
    </div>

    <button id="toggle-chat">Open Chat</button>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let roomId;
        let userId;

        //gets the room code by splitting the current URL
        let pathSegments = window.location.pathname.split('/');
        roomId = pathSegments[pathSegments.length - 1]; //getting the last segment, which is the room code
        document.getElementById('room-code').textContent = roomId; //display on screen
        
        //extract userId from url query strings
        let urlParams = new URLSearchParams(window.location.search);
        userId = urlParams.get('userId');
        document.getElementById('current-user').textContent = `Welcome ${userId}!`; //display current user

        //initialize Socket.io
        const socket = io();

        //join the room
        socket.emit('join-room', {roomId, userId});

        //this listens for users joined. when someone clicks on join room, the server sends an event
        //to all clients connected to the room and it updates the list.
        socket.on('user-joined', (data) => {
            let usersList = document.getElementById('users-list');
            let listItem = document.createElement('li');
            listItem.textContent = `${data.username}`;
            usersList.appendChild(listItem);
        });

        //this will remove the user that left from the list of users displayed
        socket.on('user-left', (data) => {
            let usersList = document.getElementById('users-list');
            let users = usersList.getElementsByTagName('li');
            for (let user of users) { //goes through list, compares the names, and deletes once found.
                if (user.textContent === data.userId) {
                    usersList.removeChild(user);
                    break;
                }
            }
        });

        //display the list of current users.
        //get the info about this room from this server 
        fetch(`/room-info/${roomId}`)
            .then(response => response.json())
            .then(data => {
                let usersList = document.getElementById('users-list');
                data.users.forEach(user => { //go through the list of users and display them
                    let listItem = document.createElement('li');
                    listItem.textContent = `${user.username}`;
                    usersList.appendChild(listItem);
                });
            })
            .catch(error => console.error('Error fetching room info:', error));

        document.getElementById('start-game').addEventListener('click', () => {
            fetch('/start-game', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ roomId })
            })
            .then(response => {
                if (response.ok) {
                    console.log('Game started');
                } else {
                    console.error('Error starting game');
                }
            });
        });

        socket.on('game-started', (data) => {
            document.getElementById('start-game').classList.add('hidden');
            document.getElementById('game-prompt').textContent = data.prompt;
            document.getElementById('game-prompt').classList.remove('hidden');
            document.getElementById('gif-container').classList.remove('hidden');
        });

        document.getElementById('search-gif').addEventListener('click', () => {
            let query = document.getElementById('gif-search').value;
            fetch(`/search-giphy?query=${query}`)
            .then(response => response.json())
            .then(data => {
                let gifResults = document.getElementById('gif-results');
                gifResults.innerHTML = '';
                data.data.forEach(gif => {
                    let img = document.createElement('img');
                    img.src = gif.images.fixed_height.url;
                    img.addEventListener('click', () => {
                        submitGif(gif.images.fixed_height.url);
                    });
                    gifResults.appendChild(img);
                });
            })
            .catch(error => console.error('Error searching Giphy:', error));
        });

        function submitGif(gifUrl) {
            fetch('/submit-gif', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ roomId, userId, gifUrl })
            })
            .then(response => {
                if (response.ok) {
                    document.getElementById('gif-container').classList.add('hidden');
                } else {
                    console.error('Error submitting GIF');
                }
            });
        }

        socket.on('next-round', (data) => {
            document.getElementById('game-prompt').textContent = data.prompt;
            document.getElementById('gif-container').classList.remove('hidden');
        });

        socket.on('voting-start', (data) => {
            document.getElementById('game-prompt').classList.add('hidden');
            document.getElementById('gif-container').classList.add('hidden');
            document.getElementById('voting-container').classList.remove('hidden');

            let gifVotes = document.getElementById('gif-votes');
            gifVotes.innerHTML = '';
            Object.entries(data.submissions).forEach(([round, submissions]) => {
                Object.entries(submissions).forEach(([userId, gifUrl]) => {
                    let div = document.createElement('div');
                    div.innerHTML = `<img src="${gifUrl}" alt="GIF"><br>User: ${userId}<br>Round: ${round}<br>`;
                    let input = document.createElement('input');
                    input.type = 'number';
                    input.min = 1;
                    input.max = 10;
                    input.dataset.userId = userId;
                    input.dataset.round = round;
                    div.appendChild(input);
                    gifVotes.appendChild(div);
                });
            });
        });

        document.getElementById('submit-votes').addEventListener('click', () => {
            let votes = {};
            let inputs = document.querySelectorAll('#gif-votes input');
            inputs.forEach(input => {
                let userId = input.dataset.userId;
                let round = input.dataset.round;
                if (!votes[userId]) {
                    votes[userId] = 0;
                }
                votes[userId] += parseInt(input.value);
            });

            fetch('/submit-vote', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ roomId, userId, votes })
            })
            .then(response => {
                if (response.ok) {
                    document.getElementById('voting-container').classList.add('hidden');
                } else {
                    console.error('Error submitting votes');
                }
            });
        });

        socket.on('game-over', (data) => {
            let scoresDiv = document.createElement('div');
            scoresDiv.innerHTML = '<h2>Game Over! Scores:</h2>';
            Object.entries(data.scores).forEach(([userId, score]) => {
                scoresDiv.innerHTML += `<p>User: ${userId} - Score: ${score}</p>`;
            });
            document.body.appendChild(scoresDiv);
        });

        // Chat functionality
        document.getElementById('toggle-chat').addEventListener('click', () => {
            document.getElementById('chat-sidebar').style.display = "block";
            //document.getElementById('chat-sidebar').classList.remove('hidden');
        });

        document.getElementById('close-chat').addEventListener('click', () => {
            document.getElementById('chat-sidebar').style.display = "none";
            //document.getElementById('chat-sidebar').classList.add('hidden');
        });

        document.getElementById('send-chat').addEventListener('click', () => {
            let message = document.getElementById('chat-input').value;
            if (message.trim()) {
                socket.emit('chat-message', { roomId, userId, message });
                document.getElementById('chat-input').value = '';
            }
        });

        // Listen for incoming chat messages
        socket.on('chat-message', (data) => {
            let chatMessages = document.getElementById('chat-messages');
            let messageDiv = document.createElement('div');
            messageDiv.textContent = `${data.username}: ${data.message}`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom
        });

    </script>
</body>
</html>
